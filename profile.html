<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">

        <!-- Bootstrap CSS -->
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
        integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z"
        crossorigin="anonymous">

        <title>Quang Test API</title>
    </head>
    <body>
        <!-- Bootstrap JavaScript -->
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
            integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
            crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
            integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
            crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
            integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
            crossorigin="anonymous"></script>

        <script>
            window.fbAsyncInit = function() {
                FB.init({
                    appId      : '1650600928436459',
                    cookie     : true,
                    xfbml      : true,
                    version    : 'v8.0'
                });

                checkLoginState();
            };

            // Javascript SDK for Facebook API
            (function(d, s, id) {
                var js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) {return;}
                js = d.createElement(s); js.id = id;
                js.src = "https://connect.facebook.net/en_US/sdk.js";
                fjs.parentNode.insertBefore(js, fjs);
            } (document, 'script', 'facebook-jssdk'));

            // Check login state
            function checkLoginState() {
                FB.getLoginStatus(function(response) {
                    statusChangeCallback(response);
                });
            }

            // Called with the results from FB.getLoginStatus()
            function statusChangeCallback(response) {
                if (response.status === 'connected') {
                    console.log('Logged in');
                    displayElements(true);
                    displayUserProfile();
                    displayUserFeed();
                }
                else {
                    console.log('Not Logged in');
                    displayElements(false);
                    window.location.href = "index.html";
                }
            }

            // Display the page elements based on the login state
            function displayElements(isLoggedIn) {
                if (isLoggedIn) {
                    document.getElementById('logoutButton').setAttribute('style', 'display:block');
                    document.getElementById('userProfile').setAttribute('style', 'display:block');
                    document.getElementById('userFeed').setAttribute('style', 'display:block');
                }
                else {
                    document.getElementById('logoutButton').setAttribute('style', 'display:none');
                    document.getElementById('userProfile').setAttribute('style', 'display:none');
                    document.getElementById('userFeed').setAttribute('style', 'display:none');
                }
            }

            // Logout
            function logout() {
                FB.logout(function(response) {
                    checkLoginState();
                });
            }

            // Display user profile
            async function displayUserProfile() {
                var userProfileJSON = await getUserProfileFromAPI();

                if(userProfileJSON && !userProfileJSON.error) {
                    console.log('User Profile:');
                    console.log(userProfileJSON);

                    var userProfile = document.createElement('div');
                    document.getElementById('userProfile').appendChild(userProfile);

                    // Create title
                    var title = document.createElement('h3');
                    var titleText = document.createTextNode("User Profile");
                    title.appendChild(titleText);
                    userProfile.appendChild(title);

                    // Build the user profile
                    var data = document.createElement('ul');
                    userProfile.appendChild(data);

                    var id = document.createElement('li');
                    id.innerHTML = userProfileJSON.id;
                    data.appendChild(id);

                    var name = document.createElement('li');
                    name.innerHTML = userProfileJSON.name;
                    data.appendChild(name);

                    var gender = document.createElement('li');
                    gender.innerHTML = userProfileJSON.gender;
                    data.appendChild(gender);

                    var birthday = document.createElement('li');
                    birthday.innerHTML = userProfileJSON.birthday;
                    data.appendChild(birthday);

                    var hometown = document.createElement('li');
                    hometown.innerHTML = userProfileJSON.hometown.name;
                    data.appendChild(hometown);

                    var email = document.createElement('li');
                    email.innerHTML = userProfileJSON.email;
                    data.appendChild(email);

                    var id = document.createElement('li');
                    id.innerHTML = '<a href="' + userProfileJSON.link + '" target="_blank">Link to profile page</a>';
                    data.appendChild(id);



                    // var userProfileString = '<h3>User Profile</h3>'
                    //     + '<ul class="list-group">'
                    //     + '<li class="list-group-item">ID: ' + userProfileJSON.id + '</li>'
                    //     + '<li class="list-group-item">Name: ' + userProfileJSON.name + '</li>'
                    //     + '<li class="list-group-item">Gender: ' + userProfileJSON.gender + '</li>'
                    //     + '<li class="list-group-item">Birthday: ' + userProfileJSON.birthday + '</li>'
                    //     + '<li class="list-group-item">Hometown: ' + userProfileJSON.hometown.name + '</li>'
                    //     + '<li class="list-group-item">Email: ' + userProfileJSON.email + '</li>'
                    //     + '<li class="list-group-item"><a href="' + userProfileJSON.link + '" target="_blank">Link to profile page</a></li>'
                    //     + '</ul>';

                    // document.getElementById('userProfile').innerHTML = userProfileString;
                }
                else {
                    console.log(userProfileJSON);
                }
            }

            // Get user profile from API
            function getUserProfileFromAPI() {
                return new Promise((resolve, reject) => {
                    FB.api('/me?fields=id, name, gender, birthday, hometown, email, link', function(response) {
                        resolve(response);
                    });
                });
            }

            // Display user feed
            async function displayUserFeed() {
                var userFeedJSON = await getUserFeedFromAPI();

                if(userFeedJSON && !userFeedJSON.error) {
                    console.log('User Feed:');
                    console.log(userFeedJSON);

                    var userFeedString = '<h3>User Feed</h3>'
                        + '<ul class="list-group">';
                    if (userFeedJSON.feed) {
                        for (var i in userFeedJSON.feed.data) {
                            if (userFeedJSON.feed.data[i].message) {
                                userFeedString = userFeedString + '<li class="list-group-item">'
                                    + '<div>Message: ' + userFeedJSON.feed.data[i].message + '</div>'
                                    + '<div><a href="' + userFeedJSON.feed.data[i].permalink_url + '" target="_blank">Link to the post</a></div>';

                                    for (var j in userFeedJSON.feed.data[i].comments.data) {
                                        if (userFeedJSON.feed.data[i].comments.data[j].message) {
                                            userFeedString = userFeedString + '<div>Comment: ' + userFeedJSON.feed.data[i].comments.data[j].message + '</div>';
                                        }
                                    }
                                    userFeedString = userFeedString + '</li>';
                            }
                        }
                    }
                    userFeedString = userFeedString + '</ul>';
                    document.getElementById('userFeed').innerHTML = userFeedString;
                }
                else {
                    console.log(userFeedJSON);
                }
            }

            // Get user feed from API
            function getUserFeedFromAPI() {
                return new Promise((resolve, reject) => {
                    FB.api('/me?fields=feed.limit(2){message,permalink_url,comments{message}}', function(response) {
                        resolve(response);
                    });
                });
            }


        </script>

        <!-- Navigation bar -->
        <nav class="navbar navbar-expand-md navbar-dark bg-dark">
            <!-- Home Button -->
            <a class="navbar-brand" href="index.html">Home</a>

            <!-- Profile Button -->
            <a class="navbar-brand" id="profileButton" href="profile.html">Profile</a>

            <!-- Page Button -->
            <a class="navbar-brand" id="pageButton" href="page.html">Page</a>
            
            <div class="collapse navbar-collapse" id="navbar">
                <ul class="navbar-nav ml-auto"> <!-- ml-auto: stick to the right -->
                    <!-- Logout Button -->
                    <button id="logoutButton" onclick="logout()" style="display:none">Logout</button>
                </ul>
            </div>
        </nav>

        <div class="container">
            <!-- User Profile -->
            <div id="userProfile"></div>

            <!-- User Feed -->
            <div id="userFeed"></div>
        </div>
    </body>
</html>
