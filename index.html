<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">

        <!-- Bootstrap CSS -->
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
        integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z"
        crossorigin="anonymous">

        <title>Canteen App</title>
    </head>
    <body>
        <!-- Bootstrap JavaScript -->
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
            integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
            crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
            integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
            crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
            integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
            crossorigin="anonymous"></script>

        <script>
            window.fbAsyncInit = async function() {
                FB.init({
                    appId      : '358441765246257',
                    cookie     : true,
                    xfbml      : true,
                    version    : 'v8.0'
                });

                var loginStateJSON = await checkLoginState();
                statusChangeCallback(loginStateJSON);
            };

            // Javascript SDK for Facebook API
            (function(d, s, id) {
                var js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) {return;}
                js = d.createElement(s); js.id = id;
                js.src = "https://connect.facebook.net/en_US/sdk.js";
                fjs.parentNode.insertBefore(js, fjs);
            } (document, 'script', 'facebook-jssdk'));

            // Check login state
            function checkLoginState() {
                return new Promise((resolve, reject) => {
                    FB.getLoginStatus(function(response) {
                        resolve(response);
                    });
                });
            }

            // Called with the results from FB.getLoginStatus()
            function statusChangeCallback(response) {
                if (response.status === 'connected') {
                    console.log('Logged in');
                    displayElements(true);
                }
                else {
                    console.log('Not Logged in');
                    displayElements(false);
                }
            }

            // Display the page elements based on the login state
            function displayElements(isLoggedIn) {
                if (isLoggedIn) {
                    document.getElementById('loginButton').setAttribute('style', 'display:none');
                    document.getElementById('logoutButton').setAttribute('style', 'display:block');
                    document.getElementById('getLongLivedPageTokenButton').setAttribute('style', 'display:block');
                }
                else {
                    document.getElementById('loginButton').setAttribute('style', 'display:block');
                    document.getElementById('logoutButton').setAttribute('style', 'display:none');
                    document.getElementById('getLongLivedPageTokenButton').setAttribute('style', 'display:none');
                }
            }

            // Login
            async function login() {
                var loginJSON = await loginThroughFacebook();
                statusChangeCallback(loginJSON);
            }

            // Login through Facebook
            function loginThroughFacebook() {
                return new Promise((resolve, reject) => {
                    FB.login(function(response) {
                        resolve(response);
                    }, {scope: 'public_profile, email, pages_show_list, pages_manage_posts, pages_manage_metadata, pages_read_engagement, pages_manage_engagement, pages_read_user_content'});
                });
            }

            // Logout
            async function logout() {
                var logoutJSON = await logoutThroughFacebook();
                var loginStateJSON = await checkLoginState();
                statusChangeCallback(loginStateJSON);
            }

            // Logout through Facebook
            function logoutThroughFacebook() {
                return new Promise((resolve, reject) => {
                    FB.logout(function(response) {
                        resolve(response);
                    });
                });
            }

            // Canteen page
            var canteenPageId = "110186127494190";
            var canteenPageToken;
            var canteenPageJSON;

            // Get long-lived page token
            async function getLongLivedPageToken() {
                var loginStateJSON = await checkLoginState();

                if (loginStateJSON.status === "connected") {
                    var longLivedUserTokenJSON = await getLongLivedUserToken(loginStateJSON.authResponse.accessToken);
                    
                    // Get the page that user admins
                    var pageJSON = await getPageFromAPI(longLivedUserTokenJSON.access_token);

                    if(pageJSON && !pageJSON.error) {
                        console.log('Page Token JSON:');
                        console.log(pageJSON);

                        if (pageJSON.accounts) {
                            canteenPageId = pageJSON.accounts.data[0].id;
                            canteenPageToken = pageJSON.accounts.data[0].access_token;
                        }
                    }
                    else {
                        console.log("Error:");
                        console.log(pageJSON);
                    }
                }
                else {
                    console.log("Error:");
                    console.log(loginStateJSON);
                }
            }

            // Get long-lived user token
            function getLongLivedUserToken(shortLivedUserToken) {
                return new Promise((resolve, reject) => {
                    FB.api('/oauth/access_token', 'get', { "grant_type":"fb_exchange_token","client_id":"358441765246257","client_secret":"5b85e65ab644a281e61556eadae7ee1d","fb_exchange_token":shortLivedUserToken }, function(response) {
                        resolve(response);
                    });
                });
            }

            // Get page from API
            function getPageFromAPI(userToken) {
                return new Promise((resolve, reject) => {
                    FB.api('/me?fields=accounts', { access_token:userToken }, function(response) {
                        resolve(response);
                    });
                });
            }
        </script>

        <!-- Navigation bar -->
        <nav class="navbar navbar-expand-md navbar-dark bg-dark">
            <!-- Home Button -->
            <a class="navbar-brand" href="index.html">Home</a>
            
            <div class="collapse navbar-collapse" id="navbar">
                <ul class="navbar-nav ml-auto"> <!-- ml-auto: stick to the right -->
                    <!-- Facebook Default Login Button -->
                    <!-- <div class="fb-login-button"
                        id="loginButton"
                        scope="public_profile, email, pages_show_list, pages_manage_posts, pages_manage_metadata, pages_read_engagement, pages_manage_engagement, pages_read_user_content"
                        onlogin="checkLoginState()">
                    </div> -->

                    <!-- Login Button -->
                    <button id="loginButton" onclick="login();" style="display:none">Login</button>
                    
                    <!-- Logout Button -->
                    <button id="logoutButton" onclick="logout();" style="display:none">Logout</button>
                </ul>
            </div>
        </nav>

        <div class="container">
            <!-- Get Long-lived Page Token Button -->
            <div>
                <button id="getLongLivedPageTokenButton" onclick="getLongLivedPageToken();" style="display:none">Get Long-lived Page Token</button>
            </div>
        </div>
    </body>
</html>
