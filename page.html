<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">

        <!-- Bootstrap CSS -->
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
        integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z"
        crossorigin="anonymous">

        <title>Quang Test API</title>
    </head>
    <body>
        <!-- Bootstrap JavaScript -->
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
            integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
            crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
            integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
            crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
            integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
            crossorigin="anonymous"></script>

        <script>
            window.fbAsyncInit = async function() {
                FB.init({
                    appId      : '1650600928436459',
                    cookie     : true,
                    xfbml      : true,
                    version    : 'v8.0'
                });

                var loginStateJSON = await checkLoginState();
                statusChangeCallback(loginStateJSON);
            };

            // Javascript SDK for Facebook API
            (function(d, s, id) {
                var js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) {return;}
                js = d.createElement(s); js.id = id;
                js.src = "https://connect.facebook.net/en_US/sdk.js";
                fjs.parentNode.insertBefore(js, fjs);
            } (document, 'script', 'facebook-jssdk'));

            // Check login state
            function checkLoginState() {
                return new Promise((resolve, reject) => {
                    FB.getLoginStatus(function(response) {
                        resolve(response);
                    });
                });
            }

            // Called with the results from FB.getLoginStatus()
            function statusChangeCallback(response) {
                if (response.status === 'connected') {
                    console.log('Logged in');
                    displayElements(true);
                }
                else {
                    console.log('Not Logged in');
                    displayElements(false);
                    window.location.href = "index.html";
                }
            }

            // Display the page elements based on the login state
            function displayElements(isLoggedIn) {
                if (isLoggedIn) {
                    document.getElementById('logoutButton').setAttribute('style', 'display:block');
                    document.getElementById('getLongLivedPageTokenButton').setAttribute('style', 'display:none');
                    document.getElementById('displayPageFeedButton').setAttribute('style', 'display:block');
                    document.getElementById('pageFeed').setAttribute('style', 'display:block');
                }
                else {
                    document.getElementById('logoutButton').setAttribute('style', 'display:none');
                    document.getElementById('getLongLivedPageTokenButton').setAttribute('style', 'display:none');
                    document.getElementById('displayPageFeedButton').setAttribute('style', 'display:none');
                    document.getElementById('pageFeed').setAttribute('style', 'display:none');
                }
            }

            // Logout
            async function logout() {
                var logoutJSON = await logoutThroughFacebook();
                var loginStateJSON = await checkLoginState();
                statusChangeCallback(loginStateJSON);
            }

            // Logout through Facebook
            function logoutThroughFacebook() {
                return new Promise((resolve, reject) => {
                    FB.logout(function(response) {
                        resolve(response);
                    });
                });
            }

            // Page list
            var pageIdList = [];
            var pageTokenList = [];
            var pageJSONList = [];

            pageIdList[0] = "100363751794472";
            pageIdList[1] = "108591264296711";
            pageTokenList[0] = "EAAXdNnoBYOsBAOd0AJwpSq4A25R4hrPstpDpaP1DDMZA6HYa0PBohfMRKDW9u0KE05indcWWguselwpD7dnCoJyssZCs3p9ZAhapYzkL9hZBKSf8EZC6D6n23chxgSI76ZC7mCTQZCt8RopZCdEOQHy8Pwd2fpYtmBLUr5eciQYKiAZDZD";
            pageTokenList[1] = "EAAXdNnoBYOsBAD7awndF2nKGak7yowgZA44Ri55ZCuZAJhzqNoSprVFWpzyj6ZBd7eSLCRUnyGmlA1vQAyh7TUlJc3lj7kmjurGM9X1ZBLKwlIlll3PyJRYJCD5sNKkIPIokYSHz9dSvvJnQVAZBBZCVfetyz3GzbtGn1ViqIWD9AZDZD";


            // Get long-lived page token
            async function getLongLivedPageToken() {
                var loginStateJSON = await checkLoginState();

                if (loginStateJSON.status === "connected") {
                    var longLivedUserTokenJSON = await getLongLivedUserToken(loginStateJSON.authResponse.accessToken);
                    
                    // Get the list of pages that the user admins
                    var pageListJSON = await getPageListFromAPI(longLivedUserTokenJSON.access_token);

                    if(pageListJSON && !pageListJSON.error) {
                        console.log('Page List:');
                        console.log(pageListJSON);

                        if (pageListJSON.accounts) {
                            for (var i in pageListJSON.accounts.data) {
                                pageIdList.push(pageListJSON.accounts.data[i].id);
                                pageTokenList.push(pageListJSON.accounts.data[i].access_token);
                            }
                        }
                    }
                    else {
                        console.log(pageListJSON);
                    }
                }
                else {
                    console.log(loginStateJSON);
                }
            }

            // Display page feed
            async function displayPageFeed() {
                document.getElementById('displayPageFeedButton').setAttribute('style', 'display:none');

                var pageFeed = document.createElement('div');
                document.getElementById('pageFeed').appendChild(pageFeed);

                // Title
                var title = document.createElement('h1');
                title.innerHTML = "Page Feed";
                pageFeed.appendChild(title);

                for (let i in pageIdList) {
                    // Get the feed of a page in the list
                    var response = await getPageFeedFromAPI(pageIdList[i]);
                    pageJSONList.push(response);
                    console.log("i = " + i);
                    console.log(response);
                    console.log(pageIdList[i]);

                    if(pageJSONList[i] && !pageJSONList[i].error) {
                        console.log(pageJSONList[i].name + ' Feed:');
                        console.log(pageJSONList[i]);

                        if (pageJSONList[i].feed) {
                            // Name
                            var name = document.createElement('h1');
                            name.innerHTML = pageJSONList[i].name + " Feed";
                            pageFeed.appendChild(name);

                            // Build feed
                            var feed = document.createElement('ul');
                            feed.className = "list-group";
                            pageFeed.appendChild(feed);

                            for (let j in pageJSONList[i].feed.data) {
                                if (pageJSONList[i].feed.data[j].message) {
                                    // Build post
                                    var post = document.createElement('li');
                                    post.className = "list-group-item";
                                    feed.appendChild(post);

                                    // Message
                                    var message = document.createElement('div');
                                    message.innerHTML = 'Message: ' + pageJSONList[i].feed.data[j].message;
                                    post.appendChild(message);

                                    // Link
                                    var link = document.createElement('div');
                                    link.innerHTML = '<a href="' + pageJSONList[i].feed.data[j].permalink_url + '" target="_blank">Link to the post</a>';
                                    post.appendChild(link);

                                    // Comment
                                    if (pageJSONList[i].feed.data[j].comments) {
                                        for (let k in pageJSONList[i].feed.data[j].comments.data) {
                                            if (pageJSONList[i].feed.data[j].comments.data[k].message) {
                                                var comment = document.createElement('div');
                                                comment.innerHTML = 'Comment: ' + pageJSONList[i].feed.data[j].comments.data[k].message;
                                                post.appendChild(comment);
                                            }
                                        }
                                    }

                                    // Get total like count of the post
                                    var pagePostLikeJSON = await getPagePostLikeFromAPI(pageJSONList[i].feed.data[j].id);

                                    if(pagePostLikeJSON && !pagePostLikeJSON.error && pagePostLikeJSON.likes.summary.total_count > 0) {
                                        var like = document.createElement('div');
                                        like.innerHTML = 'Total Like Count: ' + pagePostLikeJSON.likes.summary.total_count;
                                        post.appendChild(like);
                                    }

                                    // Like page post
                                    var likePagePostButtonDiv = document.createElement('div');
                                    post.appendChild(likePagePostButtonDiv);

                                    var likePagePostButton = document.createElement("button");
                                    likePagePostButton.innerHTML = "Like Post";
                                    likePagePostButton.onclick = async function(){
                                        var likePagePostJSON = await likePagePostThroughAPI(pageJSONList[i].feed.data[j].id, pageTokenList[i]);

                                        if(likePagePostJSON && !likePagePostJSON.error) {
                                            console.log('Successfully Like');
                                        }
                                        else {
                                            console.log(likePagePostJSON);
                                        }
                                    };
                                    likePagePostButtonDiv.appendChild(likePagePostButton);
                                }
                            }
                        }

                        // Post to page
                        // Post to page title
                        var postToPageTitle = document.createElement('h4');
                        postToPageTitle.innerHTML = "Post to " + pageJSONList[i].name;
                        pageFeed.appendChild(postToPageTitle);

                        // Post to page message
                        var postToPageMessageDiv = document.createElement('div');
                        pageFeed.appendChild(postToPageMessageDiv);

                        var postToPageMessage = document.createElement("input");
                        postToPageMessage.setAttribute("type", "text");
                        postToPageMessage.setAttribute("id", "postToPageMessage" + i);
                        postToPageMessageDiv.appendChild(postToPageMessage);

                        // Post to page button
                        var postToPageButtonDiv = document.createElement('div');
                        pageFeed.appendChild(postToPageButtonDiv);

                        var postToPageButton = document.createElement("button");
                        postToPageButton.innerHTML = "Post to Page";
                        postToPageButton.onclick = async function(){
                            var postToPageJSON = await postToPageThroughAPI(document.getElementById('postToPageMessage' + i).value, pageIdList[i], pageTokenList[i]);

                            if(postToPageJSON && !postToPageJSON.error) {
                                console.log('Successfully Post');
                            }
                            else {
                                console.log(postToPageJSON);
                            }
                        };
                        postToPageButtonDiv.appendChild(postToPageButton);
                    }
                    else {
                        console.log(pageJSONList[i]);
                    }
                }
            }

            // Get long-lived user token
            function getLongLivedUserToken(shortLivedUserToken) {
                return new Promise((resolve, reject) => {
                    FB.api('/oauth/access_token', 'get', { "grant_type":"fb_exchange_token","client_id":"1650600928436459","client_secret":"f8d40718a62d9f808819656d37e5dd8f","fb_exchange_token":shortLivedUserToken }, function(response) {
                        resolve(response);
                    });
                });
            }

            // Get page list from API
            function getPageListFromAPI(userToken) {
                return new Promise((resolve, reject) => {
                    FB.api('/me?fields=accounts', { access_token:userToken }, function(response) {
                        resolve(response);
                    });
                });
            }

            // Get page feed from API
            function getPageFeedFromAPI(pageId) {
                return new Promise((resolve, reject) => {
                    FB.api('/' + pageId + '?fields=name,feed{id,message,permalink_url,comments{message}}', function(response) {
                        resolve(response);
                    });
                });
            }

            // Get page post like from API
            function getPagePostLikeFromAPI(pagePostId) {
                return new Promise((resolve, reject) => {
                    FB.api('/' + pagePostId + '?fields=id,message,likes.summary(total_count)', function(response) {
                        resolve(response);
                    });
                });
            }

            // Like page post through API
            function likePagePostThroughAPI(pagePostId, pageToken) {
                return new Promise((resolve, reject) => {
                    FB.api('/' + pagePostId + '/likes', 'post', { access_token:pageToken }, function(response) {
                        resolve(response);
                    });
                });
            }

            // Post to page through API
            function postToPageThroughAPI(message, pageId, pageToken) {
                return new Promise((resolve, reject) => {
                    FB.api('/' + pageId + '/feed', 'post', { message:message, access_token:pageToken }, function(response) {
                        resolve(response);
                    });
                });
            }
        </script>

        <!-- Navigation bar -->
        <nav class="navbar navbar-expand-md navbar-dark bg-dark">
            <!-- Home Button -->
            <a class="navbar-brand" href="index.html">Home</a>

            <!-- Profile Button -->
            <a class="navbar-brand" id="profileButton" href="profile.html">Profile</a>

            <!-- Page Button -->
            <a class="navbar-brand" id="pageButton" href="page.html">Page</a>
            
            <div class="collapse navbar-collapse" id="navbar">
                <ul class="navbar-nav ml-auto"> <!-- ml-auto: stick to the right -->
                    <!-- Logout Button -->
                    <button id="logoutButton" onclick="logout();" style="display:none">Logout</button>
                </ul>
            </div>
        </nav>

        <div class="container">
            <!-- Get Long-lived Page Token Button -->
            <div>
                <button id="getLongLivedPageTokenButton" onclick="getLongLivedPageToken();" style="display:none">Get Long-lived Page Token</button>
            </div>

            <!-- Display Page Feed Button -->
            <div>
                <button id="displayPageFeedButton" onclick="displayPageFeed();" style="display:none">Display Page Feed</button>
            </div>

            <!-- Page Feed -->
            <div id="pageFeed"></div>
        </div>
    </body>
</html>
